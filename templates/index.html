<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUBBY - AI 자막 & 더빙</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
    font-family: 'Inter', -apple-system, sans-serif;
    background-color: #f8fafc;
    color: #1e293b;
}
.glass-card {
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(226,232,240,0.8);
}
.loading-bar {
    height: 20px;
    width: 0%;
    background-color: #3b82f6;
    border-radius: 10px;
    transition: width 0.2s ease;
}
</style>
</head>

<body class="min-h-screen py-6 px-4">

<div class="fixed top-6 right-6">
    <select id="uiLanguage" class="p-2 border rounded-lg text-sm">
        <option value="ko">한국어</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
        <option value="zh">中文</option>
    </select>
</div>

<div class="max-w-5xl mx-auto">

<header class="flex items-center mb-8">
    <h1 class="text-2xl font-bold">DUBBY</h1>
</header>

<main class="grid grid-cols-1 md:grid-cols-12 gap-6">

<div class="md:col-span-5">
    <div class="glass-card p-6 rounded-2xl shadow-sm space-y-4">

        <input type="file" id="videoFile" accept="video/*,audio/*" class="w-full">

        <select id="language" class="w-full p-3 border rounded-xl">
            <option value="ko">한국어</option>
            <option value="en">English</option>
            <option value="ja">日本語</option>
            <option value="zh">中文</option>
        </select>

        <button id="subtitleBtn"
                class="w-full bg-blue-600 text-white p-3 rounded-xl">
            자막 생성
        </button>

        <button id="dubbingBtn"
                class="w-full bg-slate-900 text-white p-3 rounded-xl">
            더빙 생성
        </button>

        <div>
            <div class="w-full bg-slate-200 rounded-full h-5">
                <div id="progressBar" class="loading-bar"></div>
            </div>
            <p class="text-right text-xs mt-1" id="progressText">0%</p>
        </div>

    </div>
</div>

<div class="md:col-span-7">
    <div class="glass-card min-h-[400px] p-4 rounded-2xl flex flex-col items-center justify-center">

        <video id="resultVideo" controls class="hidden w-full rounded-lg mb-2"></video>

        <a id="subtitleLink"
           href="#"
           target="_blank"
           class="hidden text-blue-600 underline">
           자막 다운로드
        </a>

    </div>
</div>

</main>
</div>

<script>

// =============================
// 공통 요소
// =============================

const subtitleBtn = document.getElementById("subtitleBtn");
const dubbingBtn = document.getElementById("dubbingBtn");
const videoInput = document.getElementById("videoFile");
const languageSelect = document.getElementById("language");

const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

const resultVideo = document.getElementById("resultVideo");
const subtitleLink = document.getElementById("subtitleLink");

// =============================
// 진행률 표시 함수
// =============================

function setProgress(percent){
    progressBar.style.width = percent + "%";
    progressText.textContent = percent + "%";
}

// =============================
// 파일 체크
// =============================

function validateFile(){
    const file = videoInput.files[0];
    if(!file){
        alert("파일을 선택하세요.");
        return null;
    }
    return file;
}

// =============================
// 자막 생성
// =============================

subtitleBtn.addEventListener("click", async () => {

    const file = validateFile();
    if(!file) return;

    setProgress(10);

    const formData = new FormData();
    formData.append("file", file);
    formData.append("lang", languageSelect.value);

    try{
        const response = await fetch("/subtitle", {
            method: "POST",
            body: formData
        });

        setProgress(70);

        const result = await response.json();

        // 예시: 서버에서 { subtitle_url: "...", video_url: "..." } 반환한다고 가정
        subtitleLink.href = result.subtitle_url;
        subtitleLink.classList.remove("hidden");

        resultVideo.src = result.video_url;
        resultVideo.classList.remove("hidden");

        setProgress(100);

    }catch(error){
        console.error(error);
        alert("서버 오류 발생");
        setProgress(0);
    }

});

// =============================
// 더빙 생성
// =============================

dubbingBtn.addEventListener("click", async () => {

    const file = validateFile();
    if(!file) return;

    setProgress(10);

    const formData = new FormData();
    formData.append("file", file);
    formData.append("lang", languageSelect.value);

    try{
        const response = await fetch("/dubbing", {
            method: "POST",
            body: formData
        });

        setProgress(70);

        const result = await response.json();

        resultVideo.src = result.video_url;
        resultVideo.classList.remove("hidden");

        setProgress(100);

    }catch(error){
        console.error(error);
        alert("서버 오류 발생");
        setProgress(0);
    }

});

</script>

</body>
</html>
