<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUBBY - AI ìë§‰ & ë”ë¹™</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: #f8fafc;
    color: #1e293b;
}
.glass-card {
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(226,232,240,0.8);
}
.loading-bar {
    height: 20px;
    width: 0%;
    background-color: #3b82f6;
    border-radius: 10px;
    transition: width 0.3s ease;
}
</style>
</head>

<body class="min-h-screen py-6 px-4">

<div class="max-w-5xl mx-auto">

<header class="mb-8">
    <h1 class="text-2xl font-bold">DUBBY</h1>
    <p class="text-sm text-slate-500">ìë™ ìë§‰ ìƒì„± ë° AI ë”ë¹™</p>
</header>

<main class="grid grid-cols-1 md:grid-cols-12 gap-6">

<!-- ì™¼ìª½ -->
<div class="md:col-span-5">
    <div class="glass-card p-6 rounded-2xl shadow-sm space-y-4">

        <input type="file" id="videoFile" accept="video/*,audio/*" class="w-full">

        <select id="language" class="w-full p-3 border rounded-xl">
            <option value="ko">í•œêµ­ì–´</option>
            <option value="en">English</option>
            <option value="ja">æ—¥æœ¬èª</option>
            <option value="zh-cn">ä¸­æ–‡</option>
        </select>

        <button id="subtitleBtn"
                class="w-full bg-blue-600 text-white p-3 rounded-xl">
            ìë§‰ ìƒì„±
        </button>

        <button id="dubbingBtn"
                class="w-full bg-slate-900 text-white p-3 rounded-xl">
            ë”ë¹™ ìƒì„±
        </button>

        <!-- ì§„í–‰ë¥  -->
        <div>
            <div class="w-full bg-slate-200 rounded-full h-5">
                <div id="progressBar" class="loading-bar"></div>
            </div>
            <p class="text-right text-xs mt-1" id="progressText">0%</p>
        </div>

    </div>
</div>

<!-- ì˜¤ë¥¸ìª½ -->
<div class="md:col-span-7">
    <div class="glass-card min-h-[400px] p-4 rounded-2xl flex flex-col items-center justify-center">

        <video id="resultVideo" controls class="hidden w-full rounded-lg mb-4">
            <track id="subtitleTrack"
                   kind="subtitles"
                   src=""
                   srclang="ko"
                   label="ìë§‰"
                   default>
        </video>

        <a id="subtitleLink"
           href="#"
           target="_blank"
           class="hidden text-blue-600 underline">
           ìë§‰ ë‹¤ìš´ë¡œë“œ
        </a>

    </div>
</div>

</main>
</div>

<script>

// -----------------------------
// DOM ìš”ì†Œ
// -----------------------------

const subtitleBtn = document.getElementById("subtitleBtn");
const dubbingBtn = document.getElementById("dubbingBtn");
const videoInput = document.getElementById("videoFile");
const languageSelect = document.getElementById("language");

const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

const resultVideo = document.getElementById("resultVideo");
const subtitleTrack = document.getElementById("subtitleTrack");
const subtitleLink = document.getElementById("subtitleLink");

// -----------------------------
// ì§„í–‰ë¥ 
// -----------------------------

function setProgress(percent){
    progressBar.style.width = percent + "%";
    progressText.textContent = percent + "%";
}

// -----------------------------
// íŒŒì¼ ê²€ì‚¬
// -----------------------------

function validateFile(){
    const file = videoInput.files[0];
    if(!file){
        alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
        return null;
    }
    return file;
}

// -----------------------------
// ì´ˆê¸°í™”
// -----------------------------

function resetUI(){
    resultVideo.classList.add("hidden");
    subtitleLink.classList.add("hidden");
    subtitleTrack.src = "";
    setProgress(0);
}

// -----------------------------
// ì„œë²„ ìš”ì²­
// -----------------------------

async function sendRequest(action){

    resetUI();

    const file = validateFile();
    if(!file) return;

    setProgress(10);

    const formData = new FormData();
    formData.append("audio", file);
    formData.append("action", action);

    if(action === "subtitle"){
        formData.append("subtitle_lang", languageSelect.value);
    }

    if(action === "dubbing"){
        formData.append("dubbing_lang", languageSelect.value);
    }

    try{
        const response = await fetch("/process", {
            method: "POST",
            body: formData
        });

        if(!response.ok){
            const text = await response.text();
            console.error(text);
            alert("ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
            setProgress(0);
            return;
        }

        setProgress(70);

        const result = await response.json();

        if(result.video_path){
            resultVideo.src = result.video_path;
            resultVideo.classList.remove("hidden");
        }

        // ğŸ”¥ ìë§‰ ì—°ê²° í•µì‹¬ ë¶€ë¶„
        if(result.subtitle_path){
            subtitleTrack.src = result.subtitle_path;
            subtitleTrack.srclang = languageSelect.value;
            subtitleTrack.default = true;

            resultVideo.load();  // íŠ¸ë™ ìƒˆë¡œê³ ì¹¨
            subtitleLink.href = result.subtitle_path;
            subtitleLink.classList.remove("hidden");
        }

        setProgress(100);

    }catch(error){
        console.error(error);
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        setProgress(0);
    }
}

// -----------------------------
// ë²„íŠ¼ ì´ë²¤íŠ¸
// -----------------------------

subtitleBtn.addEventListener("click", () => {
    sendRequest("subtitle");
});

dubbingBtn.addEventListener("click", () => {
    sendRequest("dubbing");
});

</script>

</body>
</html>
