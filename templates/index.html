<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DUBBY</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background-color: #f8fafc;
}
.glass-card {
    background: rgba(255,255,255,0.9);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(226,232,240,0.8);
}
.loading-bar {
    height: 18px;
    width: 0%;
    background-color: #2563eb;
    border-radius: 9px;
    transition: width 0.2s ease;
}
</style>
</head>

<body class="min-h-screen py-8 px-4">

<div class="max-w-4xl mx-auto space-y-6">

<h1 class="text-2xl font-bold">DUBBY</h1>

<div class="glass-card p-6 rounded-2xl space-y-4">

<input type="file" id="videoFile" accept="video/*,audio/*" class="hidden">

<button id="fileButton"
        class="w-full p-3 border rounded-xl bg-white">
파일 선택
</button>

<p id="fileName" class="text-sm text-slate-500">
선택된 파일 없음
</p>

<select id="language" class="w-full p-3 border rounded-xl">
<option value="ko">한국어</option>
<option value="en">English</option>
<option value="ja">日本語</option>
<option value="zh-cn">中文</option>
</select>

<button id="subtitleBtn"
        class="w-full bg-blue-600 text-white p-3 rounded-xl">
자막 생성
</button>

<button id="dubbingBtn"
        class="w-full bg-slate-900 text-white p-3 rounded-xl">
더빙 생성
</button>

<!-- 로딩바 -->
<div class="w-full bg-slate-200 rounded-full h-5 overflow-hidden">
<div id="progressBar" class="loading-bar"></div>
</div>

<p id="progressText" class="text-right text-xs">0%</p>

</div>

<!-- 결과 영상 -->
<video id="resultVideo" controls class="hidden w-full rounded-lg mt-4">
<track id="subtitleTrack"
       kind="subtitles"
       src=""
       srclang="ko"
       label="Subtitles"
       default>
</video>

</div>

<script>

const fileInput = document.getElementById("videoFile");
const fileButton = document.getElementById("fileButton");
const fileName = document.getElementById("fileName");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");
const languageSelect = document.getElementById("language");

/* 파일 버튼 */
fileButton.addEventListener("click", () => {
    fileInput.click();
});

fileInput.addEventListener("change", () => {
    if(fileInput.files.length > 0){
        fileName.textContent = fileInput.files[0].name;
    }
});

/* 업로드 함수 (진행률 포함) */
function uploadFile(actionType){

    if(fileInput.files.length === 0){
        alert("파일을 선택하세요.");
        return;
    }

    progressBar.style.width = "0%";
    progressText.textContent = "0%";

    const formData = new FormData();
    formData.append("audio", fileInput.files[0]);
    formData.append("action", actionType);
    formData.append("subtitle_lang", languageSelect.value);
    formData.append("dubbing_lang", languageSelect.value);

    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/process", true);

    /* 업로드 진행률 */
    xhr.upload.onprogress = function(e){
        if(e.lengthComputable){
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + "%";
            progressText.textContent = percent + "%";
        }
    };

    /* 완료 */
    xhr.onload = function(){

        if(xhr.status !== 200){
            alert("업로드 실패");
            return;
        }

        progressBar.style.width = "100%";
        progressText.textContent = "완료";

        const data = JSON.parse(xhr.responseText);

        const video = document.getElementById("resultVideo");
        const track = document.getElementById("subtitleTrack");

        video.src = data.video_path;
        track.src = data.subtitle_path;
        track.srclang = languageSelect.value;

        video.classList.remove("hidden");
        video.load();
    };

    xhr.onerror = function(){
        alert("네트워크 오류");
    };

    xhr.send(formData);
}

/* 버튼 연결 */
document.getElementById("subtitleBtn")
        .addEventListener("click", ()=>uploadFile("subtitle"));

document.getElementById("dubbingBtn")
        .addEventListener("click", ()=>uploadFile("dubbing"));

</script>

</body>
</html>
